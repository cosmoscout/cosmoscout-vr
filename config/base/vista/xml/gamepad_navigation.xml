<!-- ///////////////////////////////////////////////////////////////////////////////////////////////
//                               This file is part of CosmoScout VR                               //
//      and may be used under the terms of the MIT license. See the LICENSE file for details.     //
//                        Copyright: (c) 2019 German Aerospace Center (DLR)                       //
//////////////////////////////////////////////////////////////////////////////////////////////// -->

<?xml version="1.0" encoding="utf-8" ?>
<module>
    <nodespace>
    </nodespace>
    <graph>
        <!-- drivers and history projects -->
        <!--    analog driver and history -->
        <node name="vrpn_analog_driver" type="DriverSensor">
            <param name="driver" value="XBOXCONTROLLER" />
            <param name="sensor" value="0" />
            <param name="type" value="ANALOG" />
        </node>
        <node name="vrpn_analog_data" type="HistoryProject">
            <param name="project">VALUE, CHANNELS</param>
        </node>

        <!--    button driver and history -->
        <node name="vrpn_button_driver" type="DriverSensor">
            <param name="driver" value="XBOXCONTROLLER" />
            <param name="sensor" value="0" />
            <param name="type" value="BUTTON" />
        </node>
        <node name="vrpn_button_data" type="HistoryProject">
            <param name="project">BTMASK, NUMBER, STATE</param>
        </node>

        <!--    button demux -->
        <node name="btn_number_to_int" type="TypeConvert[unsigned int,int]" />

        <node name="get_button" type="Demultiplex[unsigned int]">
            <param name="num_outports">14</param>
        </node>

        <!-- observer node -->
        <node name="observer" type="ObserverNavigationNode">
            <param name="max_linear_speed" value="10, 10, 10" />
            <param name="max_angular_speed" value="1" />
        </node>

        <!--    timer node for observer -->
        <node name="timer" type="Timer" />

        <!--    compose movement vector for observer -->
        <node name="movement" type="Compose3DVector" />

        <!--    compose rotation for observer -->
        <node name="rotation" type="AxisRotate" />

        <!-- triggers for moving forward/zooming -->
        <node name="negate_triggers" type="Negate[double]" />
        <node name="triggers_to_float" type="TypeConvert[double,float]" />

        <!-- right stick for horizontal and vertical strafing/panning -->
        <node name="RStickX_to_float" type="TypeConvert[double,float]" />

        <node name="negate_RStickY" type="Negate[double]" />
        <node name="RStickY_to_float" type="TypeConvert[double,float]" />

        <!-- left and right bumpers for rolling -->
        <node name="roll_movement" type="Substract[float]" />

        <node name="lb_to_float" type="TypeConvert[unsigned int,float]" />
        <node name="rb_to_float" type="TypeConvert[unsigned int,float]" />

        <node name="rotation_axis" type="ConstantValue[VistaVector3D]">
            <param name="value" value="0,0,-1,0"/>
        </node>

        <!-- pitch control from left stick y axis -->
        <node name="pitch_axis" type="ConstantValue[VistaVector3D]">
            <param name="value" value="-1,0,0,0" />
        </node>
        <node name="pitch_to_float" type="TypeConvert[double,float]" />
        <node name="pitch_rotation" type="AxisRotate" />

        <!-- yaw control from left stick x axis -->
        <node name="yaw_axis" type="ConstantValue[VistaVector3D]">
            <param name="value" value="0,-1,0,0" />
        </node>
        <node name="yaw_to_float" type="TypeConvert[double,float]" />
        <node name="yaw_rotation" type="AxisRotate" />

        <!-- compile rotation to one Quaternion -->
        <node name="pitch_yaw" type="Multiply[VistaQuaternion]" />
        <node name="pitch_yaw_roll" type="Multiply[VistaQuaternion]" />

    </graph>
    <edges>
        <!-- drivers and history projects -->
        <!--    analog driver and history -->
        <edge fromnode="vrpn_analog_driver" fromport="history"
              tonode="vrpn_analog_data" toport="history" />

        <!--    button driver and history -->
        <edge fromnode="vrpn_button_driver" fromport="history"
              tonode="vrpn_button_data" toport="history" />

        <!--    button demux -->
        <edge fromnode="vrpn_button_data" fromport="NUMBER"
              tonode="btn_number_to_int" toport="in" />
        <edge fromnode="btn_number_to_int" fromport="out"
              tonode="get_button" toport="select" />
        <edge fromnode="vrpn_button_data" fromport="STATE"
              tonode="get_button" toport="value" />

        <!-- observer node -->
        <!--    timer node for observer -->
        <edge fromnode="timer" fromport="time"
              tonode="observer" toport="time" />

        <!--    compose movement vector for observer -->
        <edge fromnode="movement" fromport="out"
              tonode="observer" toport="translation" />

        <!-- triggers for moving forward/zooming -->
        <edge fromnode="vrpn_analog_data" fromport="VALUE_4"
              tonode="triggers_to_float" toport="in" />
        <edge fromnode="triggers_to_float" fromport="out"
              tonode="movement" toport="z" />

        <!-- right stick for horizontal and vertical strafing/panning -->
        <edge fromnode="vrpn_analog_data" fromport="VALUE_2"
              tonode="RStickX_to_float" toport="in" />
        <edge fromnode="RStickX_to_float" fromport="out"
              tonode="movement" toport="x" />
        <edge fromnode="vrpn_analog_data" fromport="VALUE_3"
              tonode="negate_RStickY" toport="in" />
        <edge fromnode="negate_RStickY" fromport="out"
              tonode="RStickY_to_float" toport="in" />
        <edge fromnode="RStickY_to_float" fromport="out"
              tonode="movement" toport="y" />

        <!-- left and right bumpers for rolling -->
        <edge fromnode="get_button" fromport="4"
              tonode="lb_to_float" toport="in" />
        <edge fromnode="get_button" fromport="5"
              tonode="rb_to_float" toport="in" />
        <edge fromnode="lb_to_float" fromport="out"
              tonode="roll_movement" toport="second" />
        <edge fromnode="rb_to_float" fromport="out"
              tonode="roll_movement" toport="first" />
        <edge fromnode="roll_movement" fromport="out"
              tonode="rotation" toport="angle" />
        <edge fromnode="rotation_axis" fromport="value"
              tonode="rotation" toport="axis" />

        <!-- pitch control from left stick y axis -->
        <edge fromnode="vrpn_analog_data" fromport="VALUE_1"
              tonode="pitch_to_float" toport="in" />
        <edge fromnode="pitch_to_float" fromport="out"
              tonode="pitch_rotation" toport="angle" />
        <edge fromnode="pitch_axis" fromport="value"
              tonode="pitch_rotation" toport="axis" />

        <!-- yaw control from left stick x axis -->
        <edge fromnode="vrpn_analog_data" fromport="VALUE_0"
              tonode="yaw_to_float" toport="in" />
        <edge fromnode="yaw_to_float" fromport="out"
              tonode="yaw_rotation" toport="angle" />
        <edge fromnode="yaw_axis" fromport="value"
              tonode="yaw_rotation" toport="axis" />

        <!-- compile rotations to one quaternion -->
        <edge fromnode="pitch_rotation" fromport="out"
              tonode="pitch_yaw" toport="first" />
        <edge fromnode="yaw_rotation" fromport="out"
              tonode="pitch_yaw" toport="second" />
        <edge fromnode="pitch_yaw" fromport="out"
              tonode="pitch_yaw_roll" toport="first" />
        <edge fromnode="rotation" fromport="out"
              tonode="pitch_yaw_roll" toport="second" />
        <edge fromnode="pitch_yaw_roll" fromport="out"
              tonode="observer" toport="rotation" />
    </edges>
</module>
